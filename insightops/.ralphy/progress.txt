# Ralphy Progress Log

- [✓] 2026-02-18 18:31 - BOT-25: Paginate inventoryLevels in multi-location aggregation. In jobProcessor.server.ts, the fetchAllLocationInventory function uses inventoryLevels(first: 50) without cursor pagination. Merchants with >50 locations get wrong totals. Add cursor-based pagination to fetch ALL inventory levels, similar to how productSync handles product pagination.
- [✓] 2026-02-18 18:46 - BOT-27: Add max retry cap to pagination throttle loop. In productSync.server.ts, the throttle retry loop uses 'continue' with no max retry count. Under persistent throttle this loops forever. Add a MAX_RETRIES constant (e.g. 10), increment a counter on each throttle, and abort with a logged warning + partial sync result when exceeded.
- [✓] 2026-02-18 19:00 - BOT-28: Paginate lineItems in sales velocity queries. In salesVelocity.server.ts, lineItems(first: 50) was not paginated — orders with >50 line items silently lost data. Added pageInfo to ORDERS_QUERY lineItems, added LINE_ITEMS_QUERY for fetching remaining lineItems per order, and added fetchRemainingLineItems with cursor-based pagination capped at MAX_LINE_ITEM_PAGES=10. Warning logged when cap is hit. 17 new tests covering parseLineItemEdges, extractId, fetchRemainingLineItems pagination/error handling, and fetchOrders integration with lineItems pagination.
- [✗] 2026-02-18 19:03 - BOT-26: Standardize all webhook processing through background job queue
- [✗] 2026-02-18 19:03 - BOT-28: Paginate lineItems in sales velocity queries
- [✓] 2026-02-18 19:10 - BOT-14: Build Money Saved calculation engine. Created MoneyImpact model in Prisma schema with shop, changeEventId (unique), estimatedSavings (Decimal), calculationMethod, and calculatedAt fields. Created moneySaved.utils.ts with pure calculation functions: calculateMoneySaved (price_error: velocity × priceDiff × 3 days × 50%; stockout/visibility: velocity × avgPrice × 3 days × 50%), getCalculationMethod (maps event types to calculation methods), formatMoneySaved (display formatting). Created moneySaved.server.ts with recordMoneySaved (persists MoneyImpact after change event creation, idempotent via unique constraint), getTotalMoneySaved, getMonthlyMoneySaved, getLifetimeMoneySaved, and getTopCatches aggregation queries for dashboard. Integrated into changeDetection.server.ts: createChangeEvent now accepts optional velocity/priceDifference params and fire-and-forgets recordMoneySaved. Updated detectPriceChanges, detectVisibilityChanges, detectInventoryZero, and detectLowStock to pass velocity data through. 25 unit tests covering all calculation methods, edge cases, and formatting.
- [✓] 2026-02-18 19:15 - BOT-13: Build context enrichment engine for alerts. Created contextEnricher.server.ts with centralized enrichment functions: enrichPriceChange (% change, direction, likelyError flag, velocity, revenue impact), enrichInventoryZero (revenueAtRiskPerHour, daysOfSalesLost, location context), enrichInventoryLow (daysUntilStockout based on velocity, location context), enrichVisibilityChange (isNowHidden flag, velocity, revenue impact), enrichThemePublish (publishedAt time, isOffHours flag). Added serializeContext for clean JSON serialization and formatContextDescription for PRD-style human-readable descriptions. Refactored changeDetection.server.ts to use enricher functions instead of inline velocity/context building. Updated emailService.server.ts digest and instant alert templates to render enriched context via formatContextDescription. 31 unit tests covering all enrichment functions, serialization, and display formatting. All 137 tests pass, TypeScript and ESLint clean.
- [✗] 2026-02-18 19:11 - BOT-13: Build context enrichment engine for alerts
- [✗] 2026-02-18 19:11 - BOT-14: Build Money Saved calculation engine
